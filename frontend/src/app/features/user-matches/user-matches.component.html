<div class="container-fluid py-4">
  <div class="row">
    <!-- Filter Sidebar - Links -->
    <div class="col-lg-3 col-md-4 mb-4">
      <div class="card sticky-top" style="top: 80px">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="fas fa-filter"></i> Filter</h5>
        </div>
        <div class="card-body">
          <!-- View Mode -->
          <div class="mb-3">
            <label class="form-label fw-bold">Ansicht</label>
            <div class="btn-group w-100" role="group">
              <input
                type="radio"
                class="btn-check"
                name="viewMode"
                id="viewGrouped"
                [checked]="viewMode === 'grouped'"
                (change)="changeViewMode('grouped')"
              />
              <label
                class="btn btn-outline-primary"
                for="viewGrouped"
                title="Gruppiert"
              >
                <i class="fas fa-users"></i>
              </label>

              <input
                type="radio"
                class="btn-check"
                name="viewMode"
                id="viewCompact"
                [checked]="viewMode === 'compact'"
                (change)="changeViewMode('compact')"
              />
              <label
                class="btn btn-outline-primary"
                for="viewCompact"
                title="Kompakt"
              >
                <i class="fas fa-th"></i>
              </label>

              <input
                type="radio"
                class="btn-check"
                name="viewMode"
                id="viewCard"
                [checked]="viewMode === 'card'"
                (change)="changeViewMode('card')"
              />
              <label
                class="btn btn-outline-primary"
                for="viewCard"
                title="Karten"
              >
                <i class="fas fa-address-card"></i>
              </label>
            </div>
          </div>

          <!-- Suche -->
          <div class="mb-3">
            <label class="form-label fw-bold">
              <i class="fas fa-search"></i> Suche
            </label>
            <input
              type="text"
              class="form-control"
              [(ngModel)]="searchText"
              (input)="filterMatches()"
              placeholder="Name oder Service..."
            />
          </div>

          <!-- Service Type Filter -->
          <div class="mb-3">
            <label class="form-label fw-bold">
              <i class="fas fa-book"></i> Service Typ
            </label>
            <select
              class="form-select"
              [(ngModel)]="selectedServiceType"
              (change)="filterMatches()"
            >
              <option value="all">Alle Services</option>
              @for (type of serviceTypes; track type) {
              <option [value]="type">{{ type }}</option>
              }
            </select>
          </div>

          <!-- Angebot/Nachfrage Filter -->
          <div class="mb-3">
            <label class="form-label fw-bold">
              <i class="fas fa-exchange-alt"></i> Art
            </label>
            <select
              class="form-select"
              [(ngModel)]="offerFilter"
              (change)="filterMatches()"
            >
              <option value="all">Alle anzeigen</option>
              <option value="offer">Nur Angebote</option>
              <option value="demand">Nur Nachfragen</option>
            </select>
          </div>

          <!-- Rating Filter -->
          @if (offerFilter === 'offer' || offerFilter === 'all') {
          <div class="mb-3">
            <label class="form-label fw-bold">
              <i class="fas fa-star"></i> Bewertung
            </label>
            <select
              class="form-select"
              [(ngModel)]="ratingFilter"
              (change)="filterMatches()"
            >
              <option value="all">Alle Bewertungen</option>
              <option value="4+">‚≠ê 4+ Sterne</option>
              <option value="3+">‚≠ê 3+ Sterne</option>
              <option value="2+">‚≠ê 2+ Sterne</option>
              <option value="1+">‚≠ê 1+ Sterne</option>
              <option value="unrated">Ohne Bewertung</option>
            </select>
          </div>
          }

          <!-- Sortierung -->
          <div class="mb-3">
            <label class="form-label fw-bold">
              <i class="fas fa-sort"></i> Sortierung
            </label>
            <select
              class="form-select"
              [(ngModel)]="sortOption"
              (change)="filterMatches()"
            >
              <option value="rating-desc">‚≠ê Bewertung (hoch ‚Üí niedrig)</option>
              <option value="rating-asc">‚≠ê Bewertung (niedrig ‚Üí hoch)</option>
              <option value="name-asc">üî§ Name (A ‚Üí Z)</option>
              <option value="name-desc">üî§ Name (Z ‚Üí A)</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="col-lg-9 col-md-8">
      <!-- Header -->
      <div class="mb-4">
        <h1 class="d-flex align-items-center gap-2">
          <i class="fas fa-handshake text-primary"></i>
          Meine Matches
        </h1>
        <p class="text-muted">Finde passende Angebote und Nachfragen</p>
      </div>

      @if (loading) {
      <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Laden...</span>
        </div>
        <p class="mt-3 text-muted">Lade Matches...</p>
      </div>
      } @else if (filteredMatches.length === 0) {
      <div class="text-center py-5">
        <i class="fas fa-inbox fa-4x text-muted mb-3"></i>
        <h2>Keine Matches gefunden</h2>
        <p class="text-muted">W√§hle zuerst einige F√§cher aus!</p>
      </div>
      } @else {
      <div id="matchesContainer" [class]="'view-' + viewMode">
        @if (viewMode === 'grouped') {
        <!-- Grouped View with Bootstrap -->
        @for (group of groupedMatches; track group.username) {
        <div class="card mb-4" [class.border-warning]="group.isPerfectMatch">
          <div
            class="card-header d-flex justify-content-between align-items-center"
            [class.bg-warning]="group.isPerfectMatch"
            [class.bg-light]="!group.isPerfectMatch"
          >
            <div class="d-flex align-items-center gap-2">
              <i class="fas fa-user"></i>
              <h5 class="mb-0">{{ group.username }}</h5>
              @if (group.userRating > 0) {
              <span class="badge bg-primary">
                ‚≠ê {{ group.userRating.toFixed(1) }} ({{ group.reviewCount }})
              </span>
              }
            </div>
            <span class="badge bg-secondary">
              {{ group.matches.length }}
              {{ group.matches.length === 1 ? "Service" : "Services" }}
            </span>
          </div>
          <div class="card-body">
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3">
              @for (match of group.matches; track match.id) {
              <div class="col">
                <div
                  class="card h-100 border-start border-4"
                  [attr.data-match-id]="match.id"
                  [class.border-primary]="match.isOffer"
                  [class.border-info]="!match.isOffer"
                  [class.border-warning]="match.isPerfectMatch"
                  [class.cursor-pointer]="match.isOffer && !match.hasActiveRequest && !match.hasActiveTutoring"
                  [style.cursor]="match.isOffer && !match.hasActiveRequest && !match.hasActiveTutoring ? 'pointer' : 'default'"
                  (click)="match.isOffer && !match.hasActiveRequest && !match.hasActiveTutoring && openRequestModal(match)"
                >
                  <div class="card-body">
                    <div
                      class="d-flex justify-content-between align-items-start mb-2"
                    >
                      <span
                        class="badge"
                        [class.bg-primary]="match.isOffer"
                        [class.bg-info]="!match.isOffer"
                      >
                        {{ match.isOffer ? "Angebot" : "Nachfrage" }}
                      </span>
                      @if (match.isPerfectMatch) {
                      <span class="badge bg-warning text-dark">
                        <i class="fas fa-star"></i> Perfect Match
                      </span>
                      }
                    </div>
                    
                    <!-- Status Badges -->
                    <div class="d-flex gap-2 mb-2 flex-wrap">
                      @if (match.hasActiveRequest) {
                        <span class="badge bg-info">
                          <i class="fas fa-paper-plane"></i> Gesendet
                        </span>
                      }
                      @if (match.hasActiveTutoring) {
                        <span class="badge bg-success">
                          <i class="fas fa-graduation-cap"></i> Aktiv
                        </span>
                      }
                      @if (match.completedCount && match.completedCount > 0) {
                        <span class="badge bg-secondary" title="Abgeschlossene Nachhilfen">
                          <i class="fas fa-check-circle"></i> {{ match.completedCount }}x
                        </span>
                      }
                    </div>
                    
                    <h6
                      class="card-title text-truncate"
                      title="{{ match.serviceTypeName }}"
                    >
                      {{ match.serviceTypeName }}
                    </h6>
                    <p
                      class="card-text text-muted small text-truncate"
                      title="{{ match.username }}"
                    >
                      {{ match.username }}
                    </p>
                    @if (match.isOffer && match.rating !== null && match.rating
                    > 0) {
                    <div class="mb-2">
                      <div class="d-flex align-items-center gap-1">
                        @for (star of [1,2,3,4,5]; track star) { @if (star <=
                        Math.floor(match.rating)) {
                        <i class="fas fa-star text-warning"></i>
                        } @else if (star === Math.ceil(match.rating) &&
                        match.rating % 1 !== 0) {
                        <i class="fas fa-star-half-alt text-warning"></i>
                        } @else {
                        <i class="fas fa-star text-muted"></i>
                        } }
                        <span class="small ms-1"
                          >({{ match.rating.toFixed(1) }})</span
                        >
                      </div>
                    </div>
                    } @else if (match.isOffer) {
                    <p class="text-muted small">Noch keine Bewertung</p>
                    }
                  </div>
                </div>
              </div>
              }
            </div>
          </div>
        </div>
        } } @else if (viewMode === 'compact') {
        <!-- Compact View with Bootstrap -->
        <div class="row row-cols-2 row-cols-md-3 row-cols-lg-4 g-3">
          @for (match of paginatedMatches; track match.id) {
          <div class="col">
            <div
              class="card h-100"
              [attr.data-match-id]="match.id"
              [class.border-primary]="match.isOffer"
              [class.border-info]="!match.isOffer"
              [class.border-warning]="match.isPerfectMatch"
              [class.cursor-pointer]="match.isOffer && !match.hasActiveRequest && !match.hasActiveTutoring"
              [style.cursor]="match.isOffer && !match.hasActiveRequest && !match.hasActiveTutoring ? 'pointer' : 'default'"
              (click)="match.isOffer && !match.hasActiveRequest && !match.hasActiveTutoring && openRequestModal(match)"
            >
              <div class="card-body text-center p-3">
                <div class="mb-2">
                  <span
                    class="badge"
                    [class.bg-primary]="match.isOffer"
                    [class.bg-info]="!match.isOffer"
                  >
                    {{ match.isOffer ? "A" : "N" }}
                  </span>
                </div>
                
                <!-- Status Badges -->
                <div class="d-flex gap-1 mb-1 justify-content-center flex-wrap">
                  @if (match.hasActiveRequest) {
                    <span class="badge bg-info" style="font-size: 0.65rem;" title="Anfrage gesendet">
                      <i class="fas fa-paper-plane"></i>
                    </span>
                  }
                  @if (match.hasActiveTutoring) {
                    <span class="badge bg-success" style="font-size: 0.65rem;" title="Aktive Nachhilfe">
                      <i class="fas fa-graduation-cap"></i>
                    </span>
                  }
                  @if (match.completedCount && match.completedCount > 0) {
                    <span class="badge bg-secondary" style="font-size: 0.65rem;" title="Abgeschlossene Nachhilfen">
                      <i class="fas fa-check-circle"></i> {{ match.completedCount }}
                    </span>
                  }
                </div>
                
                <h6
                  class="card-title small mb-1 text-truncate"
                  title="{{ match.username }}"
                >
                  {{ match.username }}
                </h6>
                <p
                  class="card-text text-muted text-truncate"
                  style="font-size: 0.75rem"
                  title="{{ match.serviceTypeName }}"
                >
                  {{ match.serviceTypeName }}
                </p>
                @if (match.isOffer && match.rating !== null && match.rating > 0)
                {
                <small class="text-warning"
                  >‚≠ê {{ match.rating.toFixed(1) }}</small
                >
                }
              </div>
            </div>
          </div>
          }
        </div>
        } @else {
        <!-- Card View (Tinder-Style) with Bootstrap -->
        <div class="d-flex justify-content-center">
          @if (filteredMatches.length > 0) { @for (match of
          [filteredMatches[currentCardIndex]]; track match.id) {
          <div
            class="card"
            style="max-width: 500px; width: 100%"
            [class.border-primary]="match.isOffer"
            [class.border-info]="!match.isOffer"
            [class.border-warning]="match.isPerfectMatch"
          >
            <div
              class="card-header text-center"
              [class.bg-primary]="match.isOffer && !match.isPerfectMatch"
              [class.bg-info]="!match.isOffer && !match.isPerfectMatch"
              [class.bg-warning]="match.isPerfectMatch"
              [class.text-white]="!match.isPerfectMatch"
            >
              <div class="d-flex justify-content-between align-items-center">
                <div class="flex-grow-1">
                  @if (match.isPerfectMatch) {
                  <span class="badge bg-warning text-dark fs-6">
                    <i class="fas fa-star"></i> Perfect Match
                  </span>
                  } @else {
                  <h5 class="mb-0">{{ match.isOffer ? "Bietet an" : "Sucht" }}</h5>
                  }
                </div>
                @if (match.isOffer && match.userRating !== null && match.userRating > 0) {
                <span class="badge" [class.bg-dark]="!match.isPerfectMatch" [class.bg-warning]="match.isPerfectMatch" [class.text-dark]="match.isPerfectMatch">
                  ‚≠ê {{ match.userRating.toFixed(1) }}
                </span>
                }
              </div>
            </div>
            <div class="card-body text-center p-5">
              <div class="mb-4">
                <i class="fas fa-user-circle fa-5x text-muted"></i>
              </div>
              
              <!-- Status Badges -->
              <div class="d-flex gap-2 mb-3 justify-content-center flex-wrap">
                @if (match.hasActiveRequest) {
                  <span class="badge bg-info fs-6">
                    <i class="fas fa-paper-plane"></i> Gesendet
                  </span>
                }
                @if (match.hasActiveTutoring) {
                  <span class="badge bg-success fs-6">
                    <i class="fas fa-graduation-cap"></i> Aktiv
                  </span>
                }
                @if (match.completedCount && match.completedCount > 0) {
                  <span class="badge bg-secondary fs-6" title="Abgeschlossene Nachhilfen mit diesem User">
                    <i class="fas fa-check-circle"></i> {{ match.completedCount }}x zusammen
                  </span>
                }
              </div>
              
              <h2 class="card-title mb-3">{{ match.username }}</h2>
              <h4 class="card-subtitle text-muted mb-4">
                {{ match.serviceTypeName }}
              </h4>
              @if (match.isOffer && match.rating !== null && match.rating > 0) {
              <div class="mb-4">
                <div class="d-flex justify-content-center gap-1 mb-2">
                  @for (star of [1,2,3,4,5]; track star) { @if (star <=
                  Math.floor(match.rating)) {
                  <i class="fas fa-star text-warning fs-4"></i>
                  } @else if (star === Math.ceil(match.rating) && match.rating %
                  1 !== 0) {
                  <i class="fas fa-star-half-alt text-warning fs-4"></i>
                  } @else {
                  <i class="fas fa-star text-muted fs-4"></i>
                  } }
                </div>
                <h5>{{ match.rating.toFixed(1) }} / 5.0</h5>
              </div>
              } @if (match.isOffer) {
              <button
                class="btn btn-lg w-100"
                [class.btn-primary]="!match.hasActiveRequest && !match.hasActiveTutoring"
                [class.btn-secondary]="match.hasActiveRequest || match.hasActiveTutoring"
                [disabled]="match.hasActiveRequest || match.hasActiveTutoring"
                (click)="openRequestModal(match)"
              >
                <i class="fas fa-paper-plane"></i> 
                @if (match.hasActiveRequest) {
                  Gesendet
                } @else if (match.hasActiveTutoring) {
                  Aktiv
                } @else {
                  Anfrage senden
                }
              </button>
              }
            </div>
          </div>
          }
          <div
            class="d-flex justify-content-center align-items-center gap-3 mt-4"
          >
            <button
              class="btn btn-outline-primary"
              (click)="previousCard()"
              [disabled]="currentCardIndex === 0"
            >
              <i class="fas fa-chevron-left"></i>
            </button>
            <span class="badge bg-secondary fs-6"
              >{{ currentCardIndex + 1 }} / {{ filteredMatches.length }}</span
            >
            <button
              class="btn btn-outline-primary"
              (click)="nextCard()"
              [disabled]="currentCardIndex >= filteredMatches.length - 1"
            >
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>
          }
        </div>
        }
      </div>

      <!-- Pagination (nur f√ºr grouped und compact) -->
      @if (viewMode !== 'card' && totalPages > 1) {
      <nav aria-label="Pagination" class="mt-4">
        <ul class="pagination justify-content-center">
          <li class="page-item" [class.disabled]="currentPage === 1">
            <a
              class="page-link"
              (click)="changePage(currentPage - 1)"
              tabindex="-1"
            >
              <i class="fas fa-chevron-left"></i>
            </a>
          </li>

          @if (startPage > 1) {
          <li class="page-item">
            <a class="page-link" (click)="changePage(1)">1</a>
          </li>
          @if (startPage > 2) {
          <li class="page-item disabled"><span class="page-link">...</span></li>
          } } @for (page of pageNumbers; track page) {
          <li class="page-item" [class.active]="page === currentPage">
            <a class="page-link" (click)="changePage(page)">{{ page }}</a>
          </li>
          } @if (endPage < totalPages) { @if (endPage < totalPages - 1) {
          <li class="page-item disabled"><span class="page-link">...</span></li>
          }
          <li class="page-item">
            <a class="page-link" (click)="changePage(totalPages)">{{
              totalPages
            }}</a>
          </li>
          }

          <li class="page-item" [class.disabled]="currentPage === totalPages">
            <a class="page-link" (click)="changePage(currentPage + 1)">
              <i class="fas fa-chevron-right"></i>
            </a>
          </li>
        </ul>
        <div class="text-center text-muted">
          {{ startItem }}-{{ endItem }} von {{ filteredMatches.length }}
        </div>
      </nav>
      } }
    </div>
  </div>
</div>

<!-- Request Modal with Bootstrap -->
@if (showModal) {
<div
  class="modal fade show d-block"
  tabindex="-1"
  style="background-color: rgba(0, 0, 0, 0.5)"
  (click)="closeModal()"
>
  <div
    class="modal-dialog modal-dialog-centered"
    (click)="$event.stopPropagation()"
  >
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-paper-plane"></i> Anfrage senden
        </h5>
        <button type="button" class="btn-close" (click)="closeModal()"></button>
      </div>
      <div class="modal-body">
        <p><strong>Anbieter:</strong> {{ selectedMatch?.username }}</p>
        <p>
          <strong>Dienstleistungsart:</strong>
          {{ selectedMatch?.serviceTypeName }}
        </p>
        <div class="alert alert-info mt-3">
          <i class="fas fa-info-circle"></i>
          Der Anbieter wird √ºber deine Anfrage benachrichtigt und kann diese
          annehmen oder ablehnen.
        </div>
        @if (modalMessage) {
        <div
          class="alert"
          [class.alert-success]="modalMessageType === 'success'"
          [class.alert-danger]="modalMessageType === 'error'"
        >
          {{ modalMessage }}
        </div>
        }
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeModal()">
          Abbrechen
        </button>
        <button
          type="button"
          class="btn btn-primary"
          (click)="submitRequest()"
          [disabled]="submitting"
        >
          @if (submitting) {
          <span class="spinner-border spinner-border-sm me-2"></span>
          } @if (isUserLoggedIn) {
            <i class="fas fa-paper-plane"></i> Anfrage senden
          } @else {
            <i class="fas fa-sign-in-alt"></i> Anmelden
          }
        </button>
      </div>
    </div>
  </div>
</div>
}
