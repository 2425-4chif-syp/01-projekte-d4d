<div class="container-fluid py-4">
  <div class="row">
    <!-- Filter Sidebar -->
    <div class="col-lg-3 col-md-4 mb-4">
      <div class="card sticky-top" style="top: 80px">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="fas fa-filter"></i> Filter</h5>
        </div>
        <div class="card-body">
          <!-- Name Search -->
          <div class="mb-3">
            <label class="form-label">
              <i class="fas fa-user"></i> Benutzer / Fach
            </label>
            <input
              type="text"
              class="form-control"
              [(ngModel)]="nameSearch"
              (input)="applyFilters()"
              placeholder="Suche..."
            />
          </div>

          <!-- Service Type -->
          <div class="mb-3">
            <label class="form-label"> <i class="fas fa-book"></i> Fach </label>
            <select
              class="form-select"
              [(ngModel)]="selectedServiceType"
              (change)="applyFilters()"
            >
              <option value="all">Alle F√§cher</option>
              @for (type of serviceTypes; track type) {
              <option [value]="type">{{ type }}</option>
              }
            </select>
          </div>

          <!-- Rating Filter -->
          <div class="mb-3">
            <label class="form-label">
              <i class="fas fa-star"></i> Bewertung
            </label>
            <select
              class="form-select"
              [(ngModel)]="ratingFilter"
              (change)="applyFilters()"
              [disabled]="serviceToggle === 'demands'"
            >
              <option value="all">Alle Bewertungen</option>
              <option value="4">‚≠ê 4+ Sterne</option>
              <option value="3">‚≠ê 3+ Sterne</option>
              <option value="2">‚≠ê 2+ Sterne</option>
              <option value="1">‚≠ê 1+ Sterne</option>
              <option value="unrated">Noch nicht bewertet</option>
            </select>
          </div>

          <!-- Sort -->
          <div class="mb-3">
            <label class="form-label">
              <i class="fas fa-sort"></i> Sortieren
            </label>
            <select
              class="form-select"
              [(ngModel)]="sortOption"
              (change)="applyFilters()"
            >
              <option value="none">Keine Sortierung</option>
              <option
                value="rating-desc"
                [disabled]="serviceToggle === 'demands'"
              >
                ‚≠ê Bewertung (hoch ‚Üí niedrig)
              </option>
              <option
                value="rating-asc"
                [disabled]="serviceToggle === 'demands'"
              >
                ‚≠ê Bewertung (niedrig ‚Üí hoch)
              </option>
              <option value="name-asc">üî§ Name (A ‚Üí Z)</option>
              <option value="name-desc">üî§ Name (Z ‚Üí A)</option>
            </select>
          </div>

          <!-- Description Tags -->
          <div class="mb-3">
            <label class="form-label">
              <i class="fas fa-search"></i> Schlagwort suchen
            </label>
            <input
              type="text"
              class="form-control"
              [(ngModel)]="descriptionSearch"
              (keypress)="onDescriptionKeypress($event)"
              placeholder="Enter dr√ºcken zum Hinzuf√ºgen"
            />
          </div>

          <!-- Show Closed Markets mit fixer Gr√∂√üe -->
          <div class="form-check mb-3">
            <input
              class="form-check-input"
              style="width: 20px; height: 20px; cursor: pointer"
              type="checkbox"
              id="closedMarkets"
              [(ngModel)]="showClosedMarkets"
              (change)="applyFilters()"
            />
            <label
              class="form-check-label ms-2"
              for="closedMarkets"
              style="cursor: pointer"
            >
              Abgelaufene anzeigen
            </label>
          </div>

          <!-- Popular Tags -->
          <div class="mb-3">
            <label class="form-label fw-bold">
              <i class="fas fa-tags"></i> Beliebte Tags
            </label>
            <div class="d-flex flex-wrap gap-2">
              <span
                class="popular-tag-pill purple"
                [class.active]="selectedTags.has('Wochenende')"
                (click)="toggleTag('Wochenende')"
              >
                Wochenende
              </span>
              <span
                class="popular-tag-pill blue"
                [class.active]="selectedTags.has('Gruppennachhilfe')"
                (click)="toggleTag('Gruppennachhilfe')"
              >
                Gruppennachhilfe
              </span>
              <span
                class="popular-tag-pill green"
                [class.active]="selectedTags.has('Einzelnachhilfe')"
                (click)="toggleTag('Einzelnachhilfe')"
              >
                Einzelnachhilfe
              </span>
              <span
                class="popular-tag-pill cyan"
                [class.active]="selectedTags.has('Online')"
                (click)="toggleTag('Online')"
              >
                Online
              </span>
              <span
                class="popular-tag-pill orange"
                [class.active]="selectedTags.has('Pr√§senz')"
                (click)="toggleTag('Pr√§senz')"
              >
                Pr√§senz
              </span>
              <span
                class="popular-tag-pill red"
                [class.active]="selectedTags.has('Pr√ºfungsvorbereitung')"
                (click)="toggleTag('Pr√ºfungsvorbereitung')"
              >
                Pr√ºfungsvorbereitung
              </span>
              <span
                class="popular-tag-pill indigo"
                [class.active]="selectedTags.has('Hausaufgaben')"
                (click)="toggleTag('Hausaufgaben')"
              >
                Hausaufgaben
              </span>
              <span
                class="popular-tag-pill pink"
                [class.active]="selectedTags.has('Intensivkurs')"
                (click)="toggleTag('Intensivkurs')"
              >
                Intensivkurs
              </span>
            </div>
          </div>

          <!-- Selected Custom Tags -->
          @if (hasCustomTags) {
          <div class="mb-0">
            <label class="form-label fw-bold">Ausgew√§hlte Tags</label>
            <div class="d-flex flex-wrap gap-2">
              @for (tag of customTags; track tag) {
              <span class="badge bg-secondary d-flex align-items-center gap-1">
                {{ tag }}
                <button
                  type="button"
                  class="btn-close btn-close-white"
                  style="width: 0.5rem; height: 0.5rem"
                  (click)="removeTag(tag)"
                ></button>
              </span>
              }
            </div>
          </div>
          }
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="col-lg-9 col-md-8">
      <!-- Header -->
      <div class="mb-4">
        <h1 class="d-flex align-items-center gap-2">
          <i class="fas fa-store text-primary"></i>
          Marktplatz
        </h1>
        <p class="text-muted">
          Finde passende Nachhilfe-Angebote oder suche nach Unterst√ºtzung
        </p>
      </div>

      <!-- Service Toggle mit fixen Checkbox-Gr√∂√üen -->
      <div class="mb-4">
        <div class="d-flex gap-3">
          <div class="form-check form-check-inline">
            <input
              type="radio"
              class="form-check-input"
              style="width: 20px; height: 20px; cursor: pointer"
              name="serviceToggle"
              id="demands"
              value="demands"
              [(ngModel)]="serviceToggle"
              (change)="onServiceToggleChange()"
            />
            <label
              class="form-check-label ms-2"
              for="demands"
              style="cursor: pointer"
            >
              <i class="fas fa-search"></i> Gesuchte Dienste
            </label>
          </div>

          <div class="form-check form-check-inline">
            <input
              type="radio"
              class="form-check-input"
              style="width: 20px; height: 20px; cursor: pointer"
              name="serviceToggle"
              id="offers"
              value="offers"
              [(ngModel)]="serviceToggle"
              (change)="onServiceToggleChange()"
            />
            <label
              class="form-check-label ms-2"
              for="offers"
              style="cursor: pointer"
            >
              <i class="fas fa-chalkboard-teacher"></i> Angebotene Dienste
            </label>
          </div>
        </div>
      </div>

      <!-- Loading -->
      @if (loading) {
      <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3 text-muted">Lade Marktplatz...</p>
      </div>
      }

      <!-- Empty State -->
      @else if (filteredItems.length === 0) {
      <div class="text-center py-5">
        <i class="fas fa-inbox fa-4x text-muted mb-3"></i>
        <h2>Keine Eintr√§ge gefunden</h2>
        <p class="text-muted">Versuche andere Filter oder Tags</p>
      </div>
      }

      <!-- Services Grid -->
      @else {
      <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
        @for (item of filteredItems; track item.id) {
        <div class="col">
          <div
            class="card h-100 border-start border-4"
            [attr.data-match-id]="item.id"
            [class.border-primary]="isOffer(item)"
            [class.border-info]="!isOffer(item)"
          >
            <div class="card-body">
              <div
                class="d-flex justify-content-between align-items-start mb-2"
              >
                <h5 class="card-title mb-0">{{ getServiceTypeName(item) }}</h5>
                <span
                  class="badge"
                  [class.bg-primary]="isOffer(item)"
                  [class.bg-info]="!isOffer(item)"
                >
                  {{ isOffer(item) ? "Angebot" : "Gesucht" }}
                </span>
              </div>

              <p class="text-muted small mb-2">
                <i class="fas fa-calendar-alt"></i>
                {{ formatDateRange(item.startDate, item.endDate) }}
              </p>

              <p class="text-muted small mb-3">
                <i class="fas fa-user"></i>
                {{ getUserName(item) }}
              </p>

              @if (item.description) {
              <p class="card-text text-truncate mb-3">{{ item.description }}</p>
              } @if (isOffer(item)) { @if (getRating(item) > 0) {
              <div class="mb-3">
                <small class="text-muted">Bewertung:</small>
                <div class="d-flex align-items-center gap-1">
                  @for (star of [1,2,3,4,5]; track star) {
                  <i
                    class="fas fa-star"
                    [class.text-warning]="star <= getRating(item)"
                    [class.text-muted]="star > getRating(item)"
                  ></i>
                  }
                  <span class="ms-2 small text-muted"
                    >({{ getRating(item).toFixed(1) }})</span
                  >
                </div>
              </div>
              } @else {
              <div class="mb-3">
                <small class="text-muted">Noch keine Bewertungen</small>
              </div>
              } } @if (isOffer(item) && isLoggedIn) {
              <button
                class="btn btn-primary w-100"
                [disabled]="sendingRequest === item.id"
                (click)="openRequestModal(item)"
              >
                @if (sendingRequest === item.id) {
                <span
                  class="spinner-border spinner-border-sm"
                  role="status"
                ></span>
                } @else {
                <i class="fas fa-paper-plane"></i>
                } Anfrage senden
              </button>
              }
            </div>
          </div>
        </div>
        }
      </div>
      }
    </div>
  </div>
</div>

<!-- Request Modal -->
@if (showRequestModal && selectedItem) {
<div class="modal-overlay" (click)="closeRequestModal()">
  <div class="modal-content-custom" (click)="$event.stopPropagation()">
    <div class="modal-header border-0">
      <h5 class="modal-title">Anfrage senden</h5>
      <button
        type="button"
        class="btn-close"
        (click)="closeRequestModal()"
      ></button>
    </div>
    <div class="modal-body">
      <p><strong>An:</strong> {{ getUserName(selectedItem) }}</p>
      <p><strong>Fach:</strong> {{ getServiceTypeName(selectedItem) }}</p>
      @if (getRating(selectedItem) > 0) {
      <div class="mb-3">
        <strong>Bewertung:</strong>
        <div class="d-flex align-items-center gap-1 mt-1">
          @for (star of [1,2,3,4,5]; track star) {
          <i
            class="fas fa-star"
            [class.text-warning]="star <= getRating(selectedItem)"
            [class.text-muted]="star > getRating(selectedItem)"
          ></i>
          }
          <span class="ms-2 small"
            >({{ getRating(selectedItem).toFixed(1) }})</span
          >
        </div>
      </div>
      } @if (modalMessage) {
      <div
        class="alert"
        [class.alert-success]="modalMessageType === 'success'"
        [class.alert-danger]="modalMessageType === 'error'"
      >
        {{ modalMessage }}
      </div>
      }
    </div>
    <div class="modal-footer border-0">
      <button
        type="button"
        class="btn btn-secondary"
        (click)="closeRequestModal()"
      >
        Abbrechen
      </button>
      <button
        type="button"
        class="btn btn-primary"
        [disabled]="submitting"
        (click)="submitRequest()"
      >
        @if (submitting) {
        <span class="spinner-border spinner-border-sm" role="status"></span>
        } Anfrage absenden
      </button>
    </div>
  </div>
</div>
}
