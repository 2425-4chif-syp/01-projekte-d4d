<div class="container-fluid p-0 chat-container">
  <div class="row g-0 h-100">
    <!-- Sidebar -->
    <div class="col-md-4 col-lg-3 chat-sidebar">
      <!-- Sidebar Header -->
      <div class="sidebar-header">
        <div class="d-flex justify-content-between align-items-center">
          <h4 class="m-0 fw-bold text-dark">Chats</h4>
        </div>
        
        <!-- Search Input -->
        <div class="search-wrapper">
          <i class="bi bi-search search-icon"></i>
          <input 
            type="text" 
            class="search-input" 
            placeholder="Search chats..."
            [(ngModel)]="searchTerm"
            (input)="filterChats()"
          >
        </div>

        <button class="btn btn-new-chat" (click)="openNewChatModal()">
          <i class="bi bi-plus-lg"></i> Start New Conversation
        </button>
      </div>

      <!-- Chat List -->
      <div class="chat-list custom-scroll">
        @for (chat of filteredChats; track chat.id) {
          <div class="chat-item" [class.active]="selectedChat?.id === chat.id" (click)="selectChat(chat)">
            <div class="chat-avatar-container">
              <div class="chat-avatar" [class.admin-avatar]="chat.isAdmin">
                {{ getInitial(chat.user2Username) }}
              </div>
              <div class="status-indicator"></div>
            </div>
            <div class="chat-info">
              <div class="d-flex justify-content-between align-items-baseline">
                <div class="chat-name">{{ chat.user2Username }}</div>
                @if (chat.lastUpdate) {
                  <div class="chat-time">{{ formatTime(chat.lastUpdate) }}</div>
                }
              </div>
              <div class="d-flex justify-content-between align-items-center">
                <div class="chat-preview">
                  {{ chat.lastMessage || 'No messages yet' }}
                </div>
              </div>
            </div>
          </div>
        }
        @if (filteredChats.length === 0) {
          <div class="text-center p-4 text-muted">
            <i class="bi bi-chat-square-text fs-1 d-block mb-2"></i>
            No conversations yet
          </div>
        }
      </div>
    </div>

    <!-- Main Chat Area -->
    <div class="col-md-8 col-lg-9 chat-main">
      @if (selectedChat) {
        <!-- Chat Header -->
        <div class="chat-header">
          <div class="d-flex align-items-center">
            <div class="chat-avatar-container me-3">
              <div class="chat-avatar" [class.admin-avatar]="selectedChat.isAdmin">
                {{ getInitial(selectedChat.user2Username) }}
              </div>
              <div class="status-indicator"></div>
            </div>
            <div>
              <h5 class="m-0 fw-bold">{{ selectedChat.user2Username }}</h5>
              <small class="text-muted">Online</small>
            </div>
          </div>
          <div class="d-flex gap-2">
            <button class="btn btn-icon" title="Search in chat">
              <i class="bi bi-search"></i>
            </button>
            <button class="btn btn-icon" title="More options">
              <i class="bi bi-three-dots-vertical"></i>
            </button>
          </div>
        </div>

        <!-- Messages -->
        <div class="messages-container custom-scroll" #messagesContainer>
          @for (msg of messages; track msg.id) {
            @if (isSystemMessage(msg)) {
              <div class="system-message">
                {{ getSystemMessageContent(msg) }}
              </div>
            } @else {
              <div class="message-wrapper" [class.user]="isCurrentUser(msg)" [class.other]="!isCurrentUser(msg)">
                <div class="message-sender">
                  {{ isCurrentUser(msg) ? 'You' : selectedChat.user2Username }}
                </div>
                <div class="message-bubble">
                  {{ msg.message }}
                </div>
                <div class="message-footer">
                  <span>{{ msg.time | date:'HH:mm' }}</span>
                  @if (isCurrentUser(msg)) {
                    <i class="bi bi-check2-all"></i>
                  }
                </div>
              </div>
            }
          }
        </div>

        <!-- Input Area -->
        <div class="input-area">
          <div class="input-wrapper">
            <button class="btn btn-icon" title="Attach file">
              <i class="bi bi-paperclip"></i>
            </button>
            <input 
              type="text" 
              class="chat-input" 
              placeholder="Type a message..." 
              [(ngModel)]="messageText" 
              (keyup.enter)="sendMessage()"
            >
            <button class="btn btn-icon" title="Emoji">
              <i class="bi bi-emoji-smile"></i>
            </button>
            <button 
              class="btn btn-icon btn-send" 
              (click)="sendMessage()" 
              [disabled]="!messageText.trim()"
            >
              <i class="bi bi-send-fill"></i>
            </button>
          </div>
        </div>
      } @else {
        <!-- Empty State -->
        <div class="empty-state">
          <div class="empty-icon">
            <i class="bi bi-chat-dots"></i>
          </div>
          <h3>Select a conversation</h3>
          <p>Choose a chat from the sidebar or start a new one.</p>
        </div>
      }
    </div>
  </div>
</div>

<!-- New Chat Modal -->
@if (showNewChatModal) {
  <div class="modal-backdrop fade show"></div>
  <div class="modal fade show d-block" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content shadow-lg border-0 rounded-4">
        <div class="modal-header border-bottom-0 pb-0">
          <h5 class="modal-title fw-bold">New Conversation</h5>
          <button type="button" class="btn-close" (click)="closeNewChatModal()"></button>
        </div>
        <div class="modal-body">
          <div class="search-wrapper mb-3">
            <i class="bi bi-search search-icon"></i>
            <input 
              id="newChatInput"
              type="text" 
              class="search-input" 
              placeholder="Search for users..."
              [(ngModel)]="newChatSearchTerm"
              (input)="searchNewUsers()"
              autocomplete="off"
            >
          </div>
          
          <div class="user-list custom-scroll" style="max-height: 300px; overflow-y: auto;">
            @if (newChatSearchTerm && foundUsers.length === 0) {
              <div class="text-center p-4 text-muted">
                <i class="bi bi-person-x fs-1 d-block mb-2"></i>
                No users found
              </div>
            } @else if (!newChatSearchTerm) {
              <div class="text-center p-4 text-muted">
                <i class="bi bi-search fs-1 d-block mb-2"></i>
                Type to search for users
              </div>
            }
            
            @for (user of foundUsers; track user.id) {
              <div class="chat-item" (click)="startNewChat(user)">
                <div class="chat-avatar-container">
                  <div class="chat-avatar" [class.admin-avatar]="user.name === 'admin'">
                    {{ getInitial(user.name) }}
                  </div>
                </div>
                <div class="chat-info">
                  <div class="chat-name">{{ user.name }}</div>
                  <div class="chat-preview text-primary">Start conversation</div>
                </div>
              </div>
            }
          </div>
        </div>
      </div>
    </div>
  </div>
}
