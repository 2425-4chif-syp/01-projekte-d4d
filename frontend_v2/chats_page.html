<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chat - D4D</title>
  <!-- Einbindung der showOffers.css für die Navbar -->
  <link rel="stylesheet" href="styles/showOffers.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    /* Chat-spezifische Styles - überschreiben showOffers.css nur für den Chat-Bereich */
    
    /* Überschreibung der Container-Styles aus showOffers.css nur für Chat */
    .chat-page-container {
      flex: 1;
      display: flex;
      margin: 15px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(255, 255, 255, 0.1);
      background-color: #fff;
      overflow: hidden;
      height: calc(100vh - 90px);
    }

    /* Chat-spezifische CSS-Variablen falls sie nicht in showOffers.css definiert sind */
    :root {
      --whatsapp-green: #25D366;
      --whatsapp-light-green: #DCF8C6;
      --whatsapp-chat-bg: #E5DDD5;
      --whatsapp-header: #075E54;
    }

    /* html und body nehmen immer die volle Höhe ein und verhindern das Browser-Scrolling */
    html,
    body {
      height: 100%;
      overflow: hidden;
    }

    body {
      font-family: "Roboto", sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #e9eff5, #ffffff);
      display: flex;
      flex-direction: column;
    }

    /* Chatliste (links) – hier bleibt die Scroll-Funktion */
    .chat-list {
      width: 30%;
      background-color: #ffffff;
      padding: 10px;
      border-right: 1px solid var(--border-color);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    .chat-list h3 {
      margin-top: 0;
      margin-bottom: 10px;
      color: var(--text-color);
    }

    /* WhatsApp-ähnliche Suchleiste */
    .search-container {
      position: relative;
      margin-bottom: 15px;
    }

    .search-container i {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: #777;
    }

    .chat-list input#searchInput {
      width: 100%;
      padding: 10px 10px 10px 35px;
      border-radius: 20px;
      border: 1px solid var(--border-color);
      background-color: #fff;
      transition: border-color 0.3s;
    }

    .chat-list input#searchInput:focus {
      outline: none;
      border-color: var(--primary-color);
    }

    .chat-list button {
      width: 100%;
      padding: 10px;
      background-color: var(--primary-color);
      color: #fff;
      border: none;
      border-radius: 5px;
      margin-bottom: 15px;
      cursor: pointer;
      font-weight: 500;
      transition: background-color 0.3s;
    }

    .chat-list button:hover {
      background-color: var(--primary-dark);
    }

    /* Chat-Kategorien */
    .chat-category {
      margin-bottom: 10px;
      padding: 5px;
      font-weight: 500;
      color: #666;
      font-size: 0.9em;
    }

    /* Chat-Items im WhatsApp-Stil */
    .chat-item {
      padding: 12px;
      border-radius: 5px;
      cursor: pointer;
      margin-bottom: 8px;
      background-color: #fff;
      display: flex;
      align-items: center;
      gap: 15px;
      position: relative;
      transition: background-color 0.3s, box-shadow 0.2s;
    }

    .chat-item:hover {
      background-color: #e9ecef;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .chat-item.active {
      background-color: #e3f2fd;
      border-left: 3px solid var(--primary-color);
    }

    .chat-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background-color: var(--primary-color);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2em;
    }

    .chat-details {
      flex: 1;
      overflow: hidden;
    }

    .chat-name {
      font-weight: 500;
      margin-bottom: 5px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .chat-last-message {
      font-size: 0.85em;
      color: #666;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .chat-meta {
      text-align: right;
      font-size: 0.75em;
      color: #777;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }

    .chat-time {
      margin-bottom: 5px;
    }

    .chat-badge {
      background-color: var(--primary-color);
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7em;
    }

    /* Chatbereich (rechts) */
    .chat-section {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      padding: 20px;
      background-color: var(--light-color);
      overflow: hidden;
    }

    .chat-section h2 {
      margin-top: 0;
      margin-bottom: 15px;
      color: var(--text-color);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .chat-section h2 i {
      color: var(--primary-color);
    }

    .chat-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border-color);
    }

    .chat-header-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .chat-header-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: var(--primary-color);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2em;
    }

    .chat-header-name {
      font-weight: 500;
      font-size: 1.2em;
    }

    .chat-header-status {
      font-size: 0.8em;
      color: #666;
    }

    /* Chat-Nachrichten Bereich */
    .chat-messages {
      flex-grow: 1;
      overflow-y: auto;
      padding: 20px;
      background-color: #f5f5f5;
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      position: relative;
    }

    /* Bilder in Chatnachrichten */
    .chat-messages img {
      max-width: 100%;
      max-height: 300px;
      border-radius: 10px;
      margin-top: 5px;
    }

    /* Custom Scrollbar */
    .chat-list::-webkit-scrollbar, .chat-messages::-webkit-scrollbar {
      width: 6px;
    }

    .chat-list::-webkit-scrollbar-track, .chat-messages::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }

    .chat-list::-webkit-scrollbar-thumb, .chat-messages::-webkit-scrollbar-thumb {
      background: #bbb;
      border-radius: 10px;
    }

    .chat-list::-webkit-scrollbar-thumb:hover, .chat-messages::-webkit-scrollbar-thumb:hover {
      background: var(--primary-color);
    }

    /* Nachrichten */
    .message {
      max-width: 70%;
      padding: 12px 18px;
      border-radius: 20px;
      position: relative;
      word-wrap: break-word;
      line-height: 1.4;
      animation: fadeIn 0.3s ease-in;
    }

    .message.user {
      background-color: var(--primary-color);
      color: #fff;
      align-self: flex-end;
      border-bottom-right-radius: 5px;
    }

    .message.other {
      background-color: #fff;
      color: var(--text-color);
      align-self: flex-start;
      border-bottom-left-radius: 5px;
    }

    .message.system {
      background-color: var(--system-bg);
      color: var(--system-text);
      align-self: center;
      font-style: italic;
      padding: 10px 16px;
      border-radius: 15px;
      max-width: 90%;
    }

    /* Benachrichtigungsstile */
    .message.system.loading {
      background-color: #e6f7ff;
      border-left: 4px solid var(--primary-color);
      color: var(--primary-dark);
    }

    .message.system.error {
      background-color: #fff2f0;
      border-left: 4px solid var(--error-color);
      color: var(--error-color);
    }

    .loading-message {
      padding: 15px;
      text-align: center;
      color: var(--primary-color);
      background-color: #e6f7ff;
      border-radius: 5px;
      margin-bottom: 10px;
      border-left: 4px solid var(--primary-color);
    }

    .error-message {
      padding: 15px;
      text-align: center;
      color: var(--error-color);
      background-color: #fff2f0;
      border-radius: 5px;
      margin-bottom: 10px;
      border-left: 4px solid var(--error-color);
    }

    .info-message {
      padding: 15px;
      text-align: center;
      color: var(--info-color);
      background-color: #e6f7ff;
      border-radius: 5px;
      margin-bottom: 10px;
      border-left: 4px solid var(--info-color);
    }

    /* Zeitanzeige in Nachrichten */
    .message-time {
      font-size: 0.75em;
      opacity: 0.7;
      margin-top: 5px;
      text-align: right;
    }

    /* Sender-Anzeige */
    .message-sender {
      font-size: 0.75em;
      font-weight: bold;
      margin-bottom: 3px;
      color: #075E54;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(5px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Spinner für Ladeanimationen */
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .fa-spinner {
      animation: spin 1s linear infinite;
    }

    /* Chat Eingabebereich */
    .chat-form-container {
      margin-top: 15px;
    }

    .chat-input-group {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .chat-input-group label.image-upload {
      cursor: pointer;
      font-size: 1.4em;
      color: var(--primary-color);
      transition: color 0.3s;
    }

    .chat-input-group label.image-upload:hover {
      color: var(--primary-dark);
    }

    .chat-input-group input[type="text"] {
      flex-grow: 1;
      padding: 12px 15px;
      border: 1px solid var(--border-color);
      border-radius: 25px;
      font-size: 1em;
      outline: none;
      transition: border-color 0.3s;
    }

    .chat-input-group input[type="text"]:focus {
      border-color: var(--primary-color);
    }

    .chat-input-group button {
      background-color: var(--primary-color);
      color: #fff;
      border: none;
      padding: 12px 20px;
      border-radius: 25px;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.2s;
      font-size: 1em;
    }

    .chat-input-group button:hover {
      background-color: var(--primary-dark);
      transform: translateY(-2px);
    }

    .chat-input-group button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
      transform: none;
    }

    /* Vorschau für hochgeladene Bilder */
    #imagePreview {
      margin-bottom: 10px;
    }

    #imagePreview img {
      max-width: 200px;
      border-radius: 10px;
    }

    #imagePreview span {
      position: absolute;
      top: -10px;
      right: -10px;
      background: red;
      color: #fff;
      border-radius: 50%;
      cursor: pointer;
      padding: 5px;
      font-weight: bold;
    }

    /* Modal-Stile */
    .modal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.9);
      background: #fff;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      border-radius: 10px;
      width: 250px;
      text-align: center;
      z-index: 200;
      opacity: 0;
      transition: opacity 0.3s, transform 0.3s;
    }

    .modal.active {
      display: block;
      opacity: 1;
      transform: translate(-50%, -50%) scale(1);
    }

    .modal h3 {
      margin-top: 0;
      color: var(--text-color);
    }

    .modal input {
      width: 100%;
      padding: 10px;
      margin: 15px 0;
      border: 1px solid var(--border-color);
      border-radius: 5px;
      outline: none;
    }

    .modal button {
      padding: 10px 15px;
      margin: 5px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 500;
      transition: background-color 0.3s, transform 0.2s;
    }

    .modal button:first-of-type {
      background-color: var(--primary-color);
      color: #fff;
    }

    .modal button:first-of-type:hover {
      background-color: var(--primary-dark);
      transform: translateY(-2px);
    }

    .modal button:last-of-type {
      background-color: #ddd;
      color: var(--text-color);
    }

    .modal button:last-of-type:hover {
      background-color: #ccc;
      transform: translateY(-2px);
    }

    /* Keine Kontakte Anzeige */
    .no-contacts {
      padding: 15px;
      text-align: center;
      color: var(--system-text);
      background-color: var(--system-bg);
      border-radius: 5px;
    }

    /* Leere Chat-Info */
    .empty-chat-info {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: #777;
    }

    .empty-chat-info i {
      font-size: 4em;
      margin-bottom: 20px;
      color: #ddd;
    }

    .empty-chat-info p {
      font-size: 1.2em;
      text-align: center;
    }

    /* Chat-Button Hervorhebung */
    .nav-buttons button.active-chat {
      background-color: var(--primary-dark) !important;
    }
  </style>
</head>

<body>
  <!-- Navigation - exakt wie in showUserServices.html -->
  <nav class="navbar">
    <div class="logo">
      <button onclick="window.location.href='index.html'" class="logo-button">
        <i class="fas fa-handshake"></i>
        <span>D4D</span>
      </button>
    </div>
    <div class="username-input-container">
      <input type="text" id="navUsername" placeholder="Benutzername eingeben..." class="username-input">
    </div>
    <div class="active-user-container">
      <span class="active-user-label">Aktiver Benutzer:</span>
      <span id="activeUserDisplay" class="active-user-name">Nicht angemeldet</span>
    </div>
    <div class="nav-buttons">
      <button id="marketButton" onclick="window.location.href='showOffers.html'">
        <i class="fas fa-store"></i>
        Zum Markt
      </button>
      <button id="offerButton" onclick="window.location.href='makeOffer.html'">
        <i class="fas fa-plus"></i>
        Dienstleistung anbieten
      </button>
      <button id="serviceButton" onclick="window.location.href='showUserServices.html'">
        <i class="fas fa-search"></i>
        Services
      </button>
      <button id="reviewButton" onclick="window.location.href='reviews.html'">
        <i class="fas fa-star"></i>
        Bewertungen
      </button>
      <button onclick="window.location.href='chats_page.html'" class="active-chat">
        <i class="fas fa-comments"></i>
        Chat
      </button>
      <button id="adminButton" onclick="window.location.href='adminLogin.html'">
        <i class="fas fa-cog"></i>
        Verwaltung
      </button>
    </div>
  </nav>

  <!-- Chat Container - verwende eigene Klasse um Konflikte mit showOffers.css zu vermeiden -->
  <main class="chat-page-container">
    <div class="chat-list">
      <h3>Chats</h3>
      <!-- Suchanzeige für Kontakte -->
      <div class="search-container">
        <i class="fas fa-search"></i>
        <input
          type="text"
          id="searchInput"
          placeholder="Kontakte durchsuchen..."
        />
      </div>
      <button id="createChatButton">+ Neuen Chat erstellen</button>
      <div id="chatItems"></div>
    </div>

    <div class="chat-section">
      <h2>
        <i class="fas fa-comments"></i>
        <span id="chatTitle">Bitte wähle einen Chat</span>
      </h2>
      <div class="chat-messages" id="chatMessages"></div>
      <div class="chat-form-container">
        <!-- Vorschau für Bild-Upload -->
        <div id="imagePreview" style="display: none;"></div>
        <form id="chatForm">
          <div class="chat-input-group">
            <label for="chatImage" class="image-upload">
              <i class="fas fa-image"></i>
            </label>
            <input
              type="file"
              id="chatImage"
              accept="image/*"
              style="display: none;"
            />
            <input
              type="text"
              id="chatInput"
              placeholder="Nachricht schreiben..."
            />
            <button type="submit">
              <i class="fas fa-paper-plane"></i> Senden
            </button>
          </div>
        </form>
      </div>
    </div>
  </main>

  <!-- Modal: Neuen Chat erstellen -->
  <div class="modal" id="chatModal">
    <h3>Neuer Chat</h3>
    <input type="text" id="chatName" placeholder="Chat Name" />
    <button onclick="createNewChat()">Erstellen</button>
    <button onclick="closeChatCreation()">Abbrechen</button>
  </div>

  <!-- Scripts - einschließlich navbar-compat.js für die Anmeldefunktionalität -->
  <script>
    // Chat-Funktionalität - MIT BESSEREN FALLBACKS
    console.log('Chat: Script startet');
    
    const API_URL = "http://localhost/api"; // Verwende das gleiche API wie andere Seiten
    let currentChatId = null;
    let currentUser = null;
    let chats = [];
    
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Chat: DOM geladen');
        
        // Lade aktiven Benutzer aus der API
        loadActiveUser();
        setupEventListeners();
    });
    
    // Lade aktiven Benutzer (wie in showUserServices)
    function loadActiveUser() {
        fetch(`${API_URL}/user`)
            .then(response => {
                if (!response.ok) {
                    throw new Error("Fehler beim Abrufen des aktiven Benutzers");
                }
                return response.text();
            })
            .then(responseText => {
                try {
                    const responseJson = JSON.parse(responseText);
                    currentUser = responseJson.username || null;
                } catch (e) {
                    currentUser = responseText && responseText.trim() !== "" ? responseText : null;
                }
                
                if (currentUser) {
                    console.log('Chat: Aktiver Benutzer geladen:', currentUser);
                    loadRealChats();
                } else {
                    console.log('Chat: Kein aktiver Benutzer, zeige Info');
                    showNoUserMessage();
                }
            })
            .catch(error => {
                console.error('Chat: API nicht verfügbar, verwende localStorage:', error);
                const savedUser = localStorage.getItem('activeUser');
                if (savedUser) {
                    currentUser = savedUser;
                    console.log('Chat: Aktiver Benutzer aus localStorage:', currentUser);
                    loadRealChats();
                } else {
                    showNoUserMessage();
                }
            });
    }
    
    function showNoUserMessage() {
        const chatList = document.getElementById('chatItems');
        if (chatList) {
            chatList.innerHTML = '<div class="no-contacts">Bitte melden Sie sich zuerst an.<br><small>Geben Sie einen Benutzernamen in die obere Suchleiste ein und drücken Enter.</small></div>';
        }
    }
    
    // Lade echte Chats aus dem Backend mit Fallback
    async function loadRealChats() {
        if (!currentUser) {
            showNoUserMessage();
            return;
        }
        
        console.log('Chat: Lade echte Chats für Benutzer:', currentUser);
        
        try {
            // 1. Versuche Chat-Endpunkte zu laden
            let contactsResponse;
            try {
                contactsResponse = await fetch(`${API_URL}/chatentry/users`);
            } catch (error) {
                console.log('Chat: Chatentry API nicht verfügbar, versuche alternative Endpunkte');
                throw error;
            }
            
            if (!contactsResponse.ok) {
                throw new Error(`API Error: ${contactsResponse.status}`);
            }
            
            const contacts = await contactsResponse.json();
            console.log('Chat: Benutzer von API erhalten:', contacts);
            
            if (contacts.length === 0) {
                showFallbackChats();
                return;
            }
            
            // 2. Für jeden Kontakt Chat-Daten aufbauen und letzte Nachricht laden
            const currentUserId = await getCurrentUserId();
            const chatPromises = contacts
                .filter(contact => contact.name !== currentUser) // Nicht mit sich selbst chatten
                .map(async (contact) => {
                    try {
                        // Lade letzte Nachrichten zwischen currentUser und diesem Kontakt
                        const messagesResponse = await fetch(`${API_URL}/chatentry/${currentUserId}/${contact.id}`);
                        
                        let lastMessage = 'Starten Sie eine Unterhaltung';
                        let lastUpdate = new Date().toISOString();
                        
                        if (messagesResponse.ok) {
                            const messages = await messagesResponse.json();
                            if (messages.length > 0) {
                                const lastMsg = messages[messages.length - 1];
                                lastMessage = lastMsg.message || 'Nachricht';
                                lastUpdate = lastMsg.time || new Date().toISOString();
                            }
                        }
                        
                        return {
                            id: contact.id,
                            user1Username: currentUser,
                            user2Username: contact.name,
                            lastMessage: lastMessage,
                            lastUpdate: lastUpdate
                        };
                    } catch (error) {
                        console.error('Chat: Fehler beim Laden der letzten Nachricht für', contact.name, ':', error);
                        return {
                            id: contact.id,
                            user1Username: currentUser,
                            user2Username: contact.name,
                            lastMessage: 'Starten Sie eine Unterhaltung',
                            lastUpdate: new Date().toISOString()
                        };
                    }
                });
            
            chats = await Promise.all(chatPromises);
            
            console.log('Chat: Verarbeitete Chats mit letzten Nachrichten:', chats);
            
            if (chats.length === 0) {
                showFallbackChats();
            } else {
                renderChatList();
                showMessage(`${chats.length} Chats mit letzten Nachrichten geladen`, 'success');
            }
            
        } catch (error) {
            console.error('Chat: Fehler beim Laden der echten Chats:', error);
            showMessage('Backend nicht verfügbar - zeige Demo-Chats', 'warning');
            showFallbackChats();
        }
    }
    
    // Fallback: Zeige Demo-Chats wenn Backend nicht verfügbar
    function showFallbackChats() {
        console.log('Chat: Zeige Fallback-Chats für:', currentUser);
        
        chats = [
            {
                id: 'demo-1',
                user1Username: currentUser,
                user2Username: "Anna Berghuber",
                lastMessage: "Hallo! Können wir heute lernen?",
                lastUpdate: new Date().toISOString()
            },
            {
                id: 'demo-2',
                user1Username: "Tom Steinmann",
                user2Username: currentUser,
                lastMessage: "Danke für die Hilfe in Mathe!",
                lastUpdate: new Date(Date.now() - 3600000).toISOString()
            },
            {
                id: 'demo-3',
                user1Username: currentUser,
                user2Username: "Lena Waldschmidt",
                lastMessage: "Wann hast du Zeit für Programmierung?",
                lastUpdate: new Date(Date.now() - 7200000).toISOString()
            },
            {
                id: 'demo-4',
                user1Username: "Robert Steinhuber",
                user2Username: currentUser,
                lastMessage: "Super, dass du mir bei BWL hilfst!",
                lastUpdate: new Date(Date.now() - 10800000).toISOString()
            }
        ];
        
        renderChatList();
        showMessage('Demo-Chats geladen (Backend nicht verfügbar)', 'info');
    }
    
    // Lade echte Nachrichten für einen Chat mit Fallback
    async function loadRealMessages(chatId) {
        if (!currentChatId || !currentUser) return;
        
        console.log('Chat: Lade Nachrichten für Chat ID:', chatId);
        
        // Prüfe ob es ein Demo-Chat ist
        if (typeof chatId === 'string' && chatId.startsWith('demo-')) {
            showDemoMessages(getOtherUserFromChat(chatId));
            return;
        }
        
        try {
            // Versuche echte Nachrichten zu laden
            const currentUserId = await getCurrentUserId();
            const response = await fetch(`${API_URL}/chatentry/${currentUserId}/${chatId}`);
            
            if (response.ok) {
                const messages = await response.json();
                console.log('Chat: Echte Nachrichten von API erhalten:', messages);
                renderRealMessages(messages);
            } else {
                console.log('Chat: Keine echten Nachrichten gefunden, zeige Demo');
                showDemoMessages(getOtherUserFromChat(chatId));
            }
        } catch (error) {
            console.error('Chat: Fehler beim Laden von Nachrichten:', error);
            showDemoMessages(getOtherUserFromChat(chatId));
        }
    }
    
    // Hilfsfunktion: Anderen Benutzer aus Chat ermitteln
    function getOtherUserFromChat(chatId) {
        const chat = chats.find(c => c.id === chatId);
        if (chat) {
            return chat.user1Username === currentUser ? chat.user2Username : chat.user1Username;
        }
        return 'Unbekannt';
    }
    
    // Demo-Nachrichten anzeigen
    function showDemoMessages(otherUser) {
        const chatMessages = document.getElementById('chatMessages');
        if (!chatMessages) return;
        
        chatMessages.innerHTML = '';
        
        const demoMessages = [
            {
                sender: otherUser,
                content: "Hallo! Wie geht es dir?",
                time: "14:30"
            },
            {
                sender: currentUser,
                content: "Hi! Mir geht es gut, danke! Können wir heute lernen?",
                time: "14:32"
            },
            {
                sender: otherUser,
                content: "Ja gerne! Um welche Zeit passt es dir?",
                time: "14:35"
            }
        ];
        
        demoMessages.forEach(msg => {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${msg.sender === currentUser ? 'user' : 'other'}`;
            
            messageDiv.innerHTML = `
                <div class="message-sender">${escapeHtml(msg.sender)}</div>
                <div>${escapeHtml(msg.content)}</div>
                <div class="message-time">${msg.time}</div>
            `;
            
            chatMessages.appendChild(messageDiv);
        });
        
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    // Hilfsfunktion: Aktuelle Benutzer-ID ermitteln mit Fallback
    async function getCurrentUserId() {
        try {
            const usersResponse = await fetch(`${API_URL}/chatentry/users`);
            if (usersResponse.ok) {
                const users = await usersResponse.json();
                const user = users.find(u => u.name === currentUser);
                return user ? user.id : 1;
            }
        } catch (error) {
            console.error('Chat: Fehler beim Ermitteln der User-ID:', error);
        }
        return 1; // Fallback
    }
    
    function showNoChatsMessage() {
        const chatList = document.getElementById('chatItems');
        if (chatList) {
            chatList.innerHTML = '<div class="no-contacts">Keine Chats vorhanden<br><small>Sie haben noch keine Chat-Nachrichten</small></div>';
        }
    }
    
    function showEmptyChat() {
        const chatMessages = document.getElementById('chatMessages');
        if (chatMessages) {
            chatMessages.innerHTML = '<div class="empty-chat-info"><i class="fas fa-comments"></i><p>Noch keine Nachrichten in diesem Chat<br><small>Schreiben Sie die erste Nachricht!</small></p></div>';
        }
    }
    
    // Event Listeners
    function setupEventListeners() {
        // Navbar-Suchfeld (für Anmeldung)
        const navUsernameInput = document.getElementById('navUsername');
        if (navUsernameInput) {
            navUsernameInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const username = this.value.trim();
                    if (username) {
                        setActiveUser(username);
                    }
                }
            });
        }
        
        // Chat-Suchfeld (für Personensuche) - UNTEN LINKS
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            searchInput.addEventListener('input', filterContacts);
        }
        
        // Chat-Form
        const chatForm = document.getElementById('chatForm');
        if (chatForm) {
            chatForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const chatInput = document.getElementById('chatInput');
                if (chatInput && chatInput.value.trim() && currentChatId) {
                    sendRealMessage(chatInput.value.trim());
                    chatInput.value = '';
                }
            });
        }
        
        // Neuen Chat erstellen
        const createChatButton = document.getElementById('createChatButton');
        if (createChatButton) {
            createChatButton.addEventListener('click', function() {
                alert('Chat-Erstellung: Diese Funktion würde ein Modal öffnen um einen neuen Chat zu starten.');
            });
        }
    }
    
    // Setze aktiven Benutzer (wie in showUserServices)
    function setActiveUser(username) {
        console.log('Chat: Setze aktiven Benutzer:', username);
        
        fetch(`${API_URL}/user`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ username: username })
        })
        .then(response => {
            if (response.ok) {
                currentUser = username;
                localStorage.setItem('activeUser', username);
                
                // Update navbar
                const activeUserDisplay = document.getElementById('activeUserDisplay');
                const navUsernameInput = document.getElementById('navUsername');
                
                if (activeUserDisplay) {
                    activeUserDisplay.textContent = username;
                    activeUserDisplay.classList.add('user-active');
                }
                
                if (navUsernameInput) {
                    navUsernameInput.value = username;
                }
                
                // Lade Chats für neuen Benutzer
                loadRealChats();
                
                showMessage(`Angemeldet als ${username}`, 'success');
                return response.text();
            } else {
                throw new Error(`Fehler beim Setzen von ${username} als aktiven Benutzer`);
            }
        })
        .catch(error => {
            console.error('Chat: API Fehler:', error);
            currentUser = username;
            localStorage.setItem('activeUser', username);
            
            const activeUserDisplay = document.getElementById('activeUserDisplay');
            if (activeUserDisplay) {
                activeUserDisplay.textContent = username;
                activeUserDisplay.classList.add('user-active');
            }
            
            loadRealChats();
            showMessage(`${username} gesetzt (API nicht verfügbar)`, 'warning');
        });
    }
    
    // Rendere Chat-Liste
    function renderChatList() {
        const chatList = document.getElementById('chatItems');
        if (!chatList) {
            console.error('chatItems nicht gefunden!');
            return;
        }
        
        chatList.innerHTML = '';
        
        if (chats.length === 0) {
            chatList.innerHTML = '<div class="no-contacts">Keine Chats vorhanden</div>';
            return;
        }
        
        chats.forEach(chat => {
            const otherUser = chat.user2Username;
            const firstLetter = otherUser.charAt(0).toUpperCase();
            
            const chatItem = document.createElement('div');
            chatItem.className = 'chat-item';
            chatItem.setAttribute('data-chat-id', chat.id);
            
            chatItem.innerHTML = `
                <div class="chat-avatar">${firstLetter}</div>
                <div class="chat-details">
                    <div class="chat-name">${escapeHtml(otherUser)}</div>
                    <div class="chat-last-message">${escapeHtml(chat.lastMessage || 'Keine Nachrichten')}</div>
                </div>
                <div class="chat-meta">
                    <div class="chat-time">${formatTime(chat.lastUpdate)}</div>
                </div>
            `;
            
            chatItem.addEventListener('click', () => selectChat(chat.id, otherUser));
            chatList.appendChild(chatItem);
        });
        
        console.log('Chat: ' + chats.length + ' Chats gerendert');
    }
    
    // Chat auswählen
    function selectChat(chatId, otherUser) {
        console.log('Chat: Wähle Chat:', chatId, 'mit', otherUser);
        currentChatId = chatId;
        
        const chatTitle = document.getElementById('chatTitle');
        if (chatTitle) {
            chatTitle.textContent = `Chat mit ${otherUser}`;
        }
        
        // Markiere aktiven Chat
        document.querySelectorAll('.chat-item').forEach(item => {
            item.classList.remove('active');
        });
        document.querySelector(`[data-chat-id="${chatId}"]`)?.classList.add('active');
        
        // Lade echte Nachrichten
        loadRealMessages(chatId);
    }
    
    // Such-Funktionalität für Kontakte
    function filterContacts() {
        const searchTerm = document.getElementById('searchInput')?.value?.toLowerCase() || '';
        const chatItems = document.querySelectorAll('.chat-item');
        
        chatItems.forEach(item => {
            const chatNameElement = item.querySelector('.chat-name');
            const chatName = chatNameElement?.textContent?.toLowerCase() || '';
            
            if (chatName.includes(searchTerm)) {
                item.style.display = 'flex';
            } else {
                item.style.display = 'none';
            }
        });
    }
    
    // Hilfsfunktionen
    function formatTime(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        const now = new Date();
        const diffMs = now - date;
        const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
        const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
        
        if (diffDays > 0) {
            return `${diffDays}d`;
        } else if (diffHours > 0) {
            return `${diffHours}h`;
        } else {
            return 'jetzt';
        }
    }
    
    function formatDateTime(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        return date.toLocaleString('de-DE', {
            hour: '2-digit',
            minute: '2-digit'
        });
    }
    
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Nachrichten anzeigen (wie in showUserServices)
    function showMessage(message, type) {
        let messageElement = document.querySelector('.response-message');
        
        if (!messageElement) {
            messageElement = document.createElement('div');
            messageElement.className = 'response-message';
            messageElement.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                padding: 10px 20px;
                border-radius: 5px;
                z-index: 1000;
                max-width: 300px;
                opacity: 0.95;
            `;
            document.body.appendChild(messageElement);
        }
        
        messageElement.textContent = message;
        messageElement.className = `response-message ${type}`;
        
        // Setze Farben basierend auf Typ
        switch(type) {
            case 'success':
                messageElement.style.backgroundColor = '#d4edda';
                messageElement.style.color = '#155724';
                messageElement.style.border = '1px solid #c3e6cb';
                break;
            case 'info':
                messageElement.style.backgroundColor = '#d1ecf1';
                messageElement.style.color = '#0c5460';
                messageElement.style.border = '1px solid #bee5eb';
                break;
            case 'warning':
                messageElement.style.backgroundColor = '#fff3cd';
                messageElement.style.color = '#856404';
                messageElement.style.border = '1px solid #ffeaa7';
                break;
            case 'error':
                messageElement.style.backgroundColor = '#f8d7da';
                messageElement.style.color = '#721c24';
                messageElement.style.border = '1px solid #f5c6cb';
                break;
        }
        
        messageElement.style.display = 'block';
        
        // Auto-hide nach 3 Sekunden
        setTimeout(() => {
            if (messageElement && messageElement.parentNode) {
                messageElement.style.display = 'none';
            }
        }, 3000);
    }
    
    // Rendere echte Nachrichten
    function renderRealMessages(messages) {
        const chatMessages = document.getElementById('chatMessages');
        if (!chatMessages) return;
        
        chatMessages.innerHTML = '';
        
        if (messages.length === 0) {
            showEmptyChat();
            return;
        }
        
        messages.forEach(message => {
            const messageDiv = document.createElement('div');
            const isCurrentUser = message.sender && message.sender.name === currentUser;
            
            messageDiv.className = `message ${isCurrentUser ? 'user' : 'other'}`;
            
            const senderName = message.sender ? message.sender.name : 'Unbekannt';
            const messageTime = message.time ? formatDateTime(message.time) : 'Jetzt';
            
            messageDiv.innerHTML = `
                <div class="message-sender">${escapeHtml(senderName)}</div>
                <div>${escapeHtml(message.message)}</div>
                <div class="message-time">${messageTime}</div>
            `;
            
            chatMessages.appendChild(messageDiv);
        });
        
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    // Sende echte Nachricht über API oder Demo
    async function sendRealMessage(message) {
        if (!message || !currentChatId || !currentUser) return;
        
        console.log('Chat: Sende Nachricht:', message);
        
        // Prüfe ob es ein Demo-Chat ist
        if (typeof currentChatId === 'string' && currentChatId.startsWith('demo-')) {
            sendDemoMessage(message);
            return;
        }
        
        try {
            const currentUserId = await getCurrentUserId();
            const response = await fetch(`${API_URL}/chatentry`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    sender: { id: currentUserId },
                    receiver: { id: currentChatId },
                    message: message,
                    time: new Date().toISOString()
                })
            });
            
            if (response.ok) {
                console.log('Chat: Nachricht erfolgreich gesendet');
                // Nachrichten neu laden
                await loadRealMessages(currentChatId);
                showMessage('Nachricht gesendet', 'success');
            } else {
                throw new Error(`API Error: ${response.status}`);
            }
        } catch (error) {
            console.error('Chat: Fehler beim Senden:', error);
            showMessage('Fehler beim Senden - verwende Demo-Modus', 'warning');
            sendDemoMessage(message);
        }
    }
    
    // Demo-Nachricht senden (Fallback)
    function sendDemoMessage(message) {
        const chatMessages = document.getElementById('chatMessages');
        if (!chatMessages || !currentChatId) return;
        
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message user';
        
        const now = new Date();
        const time = now.getHours() + ':' + now.getMinutes().toString().padStart(2, '0');
        
        messageDiv.innerHTML = `
            <div class="message-sender">${escapeHtml(currentUser)}</div>
            <div>${escapeHtml(message)}</div>
            <div class="message-time">${time}</div>
        `;
        
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        
        // Update last message in chat list
        const chat = chats.find(c => c.id === currentChatId);
        if (chat) {
            chat.lastMessage = message;
            renderChatList();
        }
        
        // Automatische Demo-Antwort nach 2 Sekunden
        setTimeout(() => {
            const otherUser = getOtherUserFromChat(currentChatId);
            const responseMessages = [
                "Das ist interessant!",
                "Verstehe, danke für die Info.",
                "Können wir uns morgen treffen?",
                "Ja, das passt mir gut.",
                "Super, freue mich darauf!"
            ];
            
            const randomResponse = responseMessages[Math.floor(Math.random() * responseMessages.length)];
            
            const responseDiv = document.createElement('div');
            responseDiv.className = 'message other';
            
            const responseTime = (now.getHours()) + ':' + (now.getMinutes() + 1).toString().padStart(2, '0');
            
            responseDiv.innerHTML = `
                <div class="message-sender">${escapeHtml(otherUser)}</div>
                <div>${escapeHtml(randomResponse)}</div>
                <div class="message-time">${responseTime}</div>
            `;
            
            chatMessages.appendChild(responseDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Update chat list
            if (chat) {
                chat.lastMessage = randomResponse;
                renderChatList();
            }
        }, 2000);
    }
    
    console.log('Chat: Initialisierung abgeschlossen');
  </script>
  <script src="scripts/navbar-compat.js"></script>
</body>
</html>
